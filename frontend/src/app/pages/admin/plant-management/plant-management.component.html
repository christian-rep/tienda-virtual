<div class="plant-management-container">
  <div class="header">
    <h1>Gestión de Plantas</h1>
    <button class="btn-primary" (click)="nuevaPlanta()">
      <i class="fas fa-plus"></i> Nueva Planta
    </button>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando plantas...</p>
  </div>

  <!-- Formulario de edición/creación -->
  <div *ngIf="plantaSeleccionada" class="edit-form">
    <h2>{{ modoEdicion === 'crear' ? 'Nueva Planta' : 'Editar Planta' }}</h2>
    <form [formGroup]="plantaForm" (ngSubmit)="guardarPlanta()">
      <div class="form-group">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" formControlName="nombre" required>
      </div>

      <div class="form-group">
        <label for="nombre_cientifico">Nombre Científico:</label>
        <input type="text" id="nombre_cientifico" formControlName="nombre_cientifico">
      </div>

      <div class="form-group">
        <label for="descripcion">Descripción:</label>
        <textarea id="descripcion" formControlName="descripcion" rows="4" required></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="precio">Precio:</label>
          <input type="number" id="precio" formControlName="precio" min="0" step="0.01" required>
        </div>

        <div class="form-group">
          <label for="stock">Stock:</label>
          <input type="number" id="stock" formControlName="stock" min="0" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="nivel_dificultad">Nivel de Dificultad:</label>
          <select id="nivel_dificultad" formControlName="nivel_dificultad" required>
            <option value="facil">Fácil</option>
            <option value="medio">Medio</option>
            <option value="dificil">Difícil</option>
          </select>
        </div>

        <div class="form-group">
          <label for="toxicidades">Nivel de Toxicidad:</label>
          <select id="toxicidades" formControlName="toxicidades" required>
            <option *ngFor="let t of nivelesToxicidad" [value]="t.id">{{ t.nivel | titlecase }}</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="categorias">Categorías:</label>
        <select id="categorias" formControlName="categorias" multiple>
          <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
        </select>
        <small class="form-text">Mantenga presionado Ctrl para seleccionar múltiples categorías</small>
      </div>

      <div class="form-group">
        <label for="imagenes">Imágenes</label>
        <input 
          type="file" 
          id="imagenes" 
          name="imagenes" 
          multiple 
          accept="image/*"
          (change)="onFileSelected($event)"
          class="form-control"
        >
        <small class="form-text text-muted">Puedes seleccionar hasta 5 imágenes. La primera será la imagen principal.</small>
        
        <!-- Vista previa de imágenes -->
        <div class="imagenes-preview mt-3" *ngIf="imagenesPrevia.length > 0">
          <div class="row">
            <div class="col-md-3 mb-3" *ngFor="let imagen of imagenesPrevia">
              <div class="card">
                <img [src]="imagen.url" class="card-img-top" [alt]="'Vista previa'">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <button 
                      type="button" 
                      class="btn btn-sm" 
                      [class.btn-primary]="imagen.es_principal"
                      [class.btn-outline-primary]="!imagen.es_principal"
                      (click)="setPrincipalImage(imagen)"
                    >
                      {{ imagen.es_principal ? 'Principal' : 'Hacer principal' }}
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger"
                      (click)="removeImage(imagen)"
                    >
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" [disabled]="plantaForm.invalid">
          <i class="fas fa-save"></i> Guardar
        </button>
        <button type="button" class="btn-secondary" (click)="cancelarEdicion()">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de plantas -->
  <div *ngIf="!loading && !plantaSeleccionada" class="plants-list">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Nombre Científico</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Categorías</th>
            <th>Dificultad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let planta of plantas">
            <td>{{ planta.nombre }}</td>
            <td><em>{{ planta.nombre_cientifico }}</em></td>
            <td>{{ planta.precio | currency }}</td>
            <td [ngClass]="{'low-stock': planta.stock < 5}">{{ planta.stock }}</td>
            <td>
              <span *ngFor="let catId of planta.categorias" class="badge">
                {{ getCategoryName(catId) }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="'badge-' + planta.nivel_dificultad">
                {{ planta.nivel_dificultad }}
              </span>
            </td>
            <td class="actions">
              <button class="btn-icon" (click)="editarPlanta(planta)" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" (click)="eliminarPlanta(planta.id)" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div> 